# 中断系统

**中断**

```
CPU中止当前正在执行的程序转而与处理随机提出的请求，待处理完毕后再回到原先被打断的程度继续执行
```

**中断系统**

```
响应和处理各种中断的软、硬间总体称作中断系统。
```

**<font color=red>中断的分类</font>**

在计算机中，中断可以分为内部中断、外部中断、软件中断三类。

- `内部中断` 由CPU内部的异常引起
- `外部中断` 由中断信号引起
- `软件中断` 由陷入指令引起，用于供操作系统服务

外部中断又分为`可屏蔽中断`和`不可屏蔽中断`



## 1.中断的分类与分级

**中断源** 

```
引起中断的各种事件称作中断源
```

**中断请求** 

```
中断源向中断系统发出请求中断的申请，称为中断请求
```

**中断响应**

中断响应就是允许CPU暂停正在执行的程序，转去对该请求进行预处理，包括**保存断点及现场**，调出有关处理该中断的中断处理程序，准备运行中断处理程序。

同时发生多个中断事件时，中断系统需要按照事项确定好的中断响应优先次序对优先级高的中断请求予以响应。

### 1.1中断的分类

为处理一个中断请求，需要调出相应的中断处理程序。如果中断源少，通过中断系统硬件就可以对每个中断源直接形成相应的中断处理程序入口。

但是对中大型多用途计算机，中断源数量巨大，为每一个中断源单独形成入口，硬件实现困难、代价大，而且不少中断源性质相近，单独实现处理程序也没必要

将中断源性质相近的归为一类，为每一类中断给定一个中断处理程序入口。再由软件分支转入相应的中断处理部分。这样可以大大简化中断处理程序入口地址形成硬件。

**中断向量表**



**中断的分类（IBM370的分类：从高到低）**

- **机器校验中断**

- **访管中断**
    - 在用户程序需要操作系统介入时（调用访管指令），通过执行“访管”指令时发生，访管原因由“访管”指令中的8位码指明
- **程序性中断**
    - 包括指令和数据的格式错误
    - 程序执行过程中出现异常（非法指令、目态下执行管态指令、主存访问方式保护、寻址超过主存容量、各种溢出、除0、有效位为0）
    - 程序的事件记录
    - 监督程序对事件的检测
- **外部中断**
    - 来自计算机外部，包括
        - 各种**定时器中断**： 用以计时、计费、控制等
        - **外部信号中断**：主要用于与其他计算机和系统的联系
        - **中断键中断**：用于操作员对计算机的干预。
    - 可分为两类：一类是若未被响应则继续保留。另一类是如不响应，则不再保留.
- **输入、输出中断**
    - 是CPU与I/O设备及通道联系的工具,在输入输出操作完成、IO通道或设备故障时发生
- **重新启动中断**
    - 是未操作员或另一台CPU要启动一个程序所用。CPU不能禁止这种中断。



#### 1.1.1 异常与中断

将中断正在执行程序的事件进一步细分为中断和异常两类。

异常由现行指令引起的暂停事件，如运算结果溢出、页面失效，一般不能屏蔽

中断则专指与当前运行程序无关的请求暂停的事件，如机器故障中断。

异常可以分为: 自陷、故障、失败三种



### 1.2中断的分级

中断因为随机地发出，所以常常会同时发生多个中断请求。

同一类的各<u>中断请求</u>的响应和处理的优先次序，一般不由中断系统的硬件管理而是由中断系统中的软件或通道来管理。

不同类的中断根据中断的性质、紧迫性、重要性、软件处理便利性划分为不同的级别。中断系统按照中断源的优先级高低来响应。

- 优先级最高的划分为第一级，其次第二级，再次是第三级...
- 不同计算机优先级高低划分有所不同，一般将
    - 机器校验划分为<u>第一级</u>
    - 程序性和管理程序调用为<u>第二级</u>
    - 外部划分为<u>第三级</u>
    - 输入输出划分为<u>第四级</u>
    - 重新启动划分为<u>最低级</u>



机器校验划分为第一级是因为掉电、地址错、数据错、通路错等必须及时处理，否则系统无法正常工作。但对只影响局部的某些故障的优先级可以低一些（例如讲将通道或外部设备故障归为输入输出所在级别）。

- 有些计算机系统中还划分有0级
    - 当计算机因故障重叠发生或无法排除，完全无法工作时，有中断系统硬设备发出计算机告急
    - 它或向操作员报警请求直接干预；或向其他计算机求援，进行计算机之间的任务切换
    - 这种告急不是真正的中断级，不参加中断级排队，中断后也**无法自行恢复**。



中断嵌套



## 2.中断的响应次序与处理次序

**响应次序**

中断的响应次序是在同时发生多个不同中断类的中断请求时，中断响应硬件中的**排队器**所决定的响应次序。 



**处理次序**

中断处理程序可以被高优先级的中断请求中断，高优先级中断请求响应完毕后继续回到上一个被中断的中断处理程序继续响应上一个中断请求。



中断响应的次序是用**排队器硬件**来实现的，次序是**由高到低固定**的。

计算机通过设置**中断级屏蔽位寄存器**来灵活改变事件的中断处理次序，决定某级中断请求能否进入中断响应排队器。只要进入排队器的总是优先响应优先级高的。

操作系统通过对每类中断处理程序的现行PSW中的中断级屏蔽位设置，可以实现希望的处理次序。

PSW: 反应当前执行程序的状态，包含

- CPU的工作状态码（目态、管态）
- 条件码（反映指令执行后的结果特征）
- 中断屏蔽码（是否允许屏蔽）

【例3-3】假设某系统又4级中断，相应的每一级中断处理程序的现行PSW中都有4位中断屏蔽位。若位1，表示对该级中断开发，0表示对该级中断屏蔽。那么要让各级中断处理次序和响应次序都一样（1>2>3>4或1>4>3>2),那么按照如下方式设置屏蔽位即可： 此处0为屏蔽， 1为开放

对当前级之后的进行屏蔽， 对之前的开放

屏蔽位越多的，优先级越高

![计算机系统结构drawio-中断屏蔽位2](https://gitee.com/Dreams_rj/dreams-img/raw/master/imgs/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84drawio-%E4%B8%AD%E6%96%AD%E5%B1%8F%E8%94%BD%E4%BD%8D2.png)



在设置中断屏蔽位时，应遵守在执行某级中断处理程序时，现行PSW中应<font style="color:red">**屏蔽同级和低级**</font>的中断请求。并通过**返回地址堆栈**确保中断嵌套时可以保证程序的正确执行次序。

==用户程序（目态程序）不能屏蔽任何中断，即用户程序的PSW的中断屏蔽位应对各级屏蔽都开放==



中断次序执行图：

![image-20220410094032829](https://gitee.com/Dreams_rj/dreams-img/raw/master/imgs/image-20220410094032829.png)









>【1510真题】设中断级屏蔽位“1”对应于开放，“0”对应于屏蔽，各级中断处理程序的中
>断级屏蔽位设置如题表所示。（10分）
>中断处理顺序为1→4→3→2
>如果所有的中断处理各需3个单位时间，中断响应和中断返回时间相对中断处理时间少得多。
>当计算机正在运行用户程序时，同时发生第2、3级中断请求，过两个单位时间后，又同时发生
>1、4级中断请求，试画出程序运行过程示意图。
>
><img src="https://gitee.com/Dreams_rj/dreams-img/raw/master/imgs/image-20220410094744866.png" alt="image-20220410094744866" style="zoom:50%;" />



## 3.中断系统的软、硬件功能分配

### 中断系统的功能 \*\*

- 中断请求的保存清除
- 优先级确定
- 中断断点及现场的保存
- 对中断请求的分析和处理
- 中断返回

这些功能都是由中断系统的**中断响应硬件**和**中断处理软件**完成的。中断系统的软、硬件功能分配实质上是中断处理程序软件和中断响应硬件的功能分配。



### 功能的实现

1. 早期，大部分功能是由软件实现的，中断响应和处理时间较长
2. 后来中断响应及其次序由程序查询软件改为用中断响应排队器硬件实现。
3. 中断的分析也由程序查询改为中断编码，直接或经中断向量表间接形成各种中断处理程序的入口地址。进而发展成每级中断经中断响应硬件形成该级中断PSW地址的入口，再把中断源的状况以中断码的形式经旧PSW告知中断处理程序。



### 中断现场

中断现场包括***软件状态***和***硬件状态***。

- **软件状态**
    - 如左右码长和级别，上下界值，各种软件状态和标志等
    - 软件状态本来就在主存中，同时其数量随操作系统的发展在扩大，宜于经中断处理程序保存。

- **硬件状态**
    - 如现行指令地址，条件码等状态信息，各种控制寄存器及通用寄存器内容
    - 硬件状态的保存具有两种方式
        - 1.经中断响应硬件保存
        - 2.经中断处理程序保存
        - 实际情况是部分经中断响应硬件保存，部分经中断处理程序保存
        - 两种保存的方式要视计算机的规模和使用场景而定
    - 硬件状态随计算机日益复杂而越加多，若全由中断处理程序保存，会延缓转入真正处理该中断请求的时间。且部分硬件状态无法使用机器指令访问（若为各种硬件状态都设置专门指令保存，指令系统会过于复杂）所以通常采用把分散于CPU各个部分的硬件状态组成PSW（部分计算机是CPU状态字或换道区），然后由中断响应硬件通过将PSW存到主存指定地址的方式保存，再把新的PSW从指定地址读取到有关寄存器中建立新的运行环境。

![计算机系统结构drawio-中断软硬件功能](https://gitee.com/Dreams_rj/dreams-img/raw/master/imgs/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84drawio-%E4%B8%AD%E6%96%AD%E8%BD%AF%E7%A1%AC%E4%BB%B6%E5%8A%9F%E8%83%BD.png)

### 中断响应时间

中断响应时间主要取决于PSW交换的时间。

为减少中断处理程序保存通用寄存器内容所耗费的时间，设置通用寄存器组与主存或堆栈之间的成组传送指令是必要的，至少可以减少大量的取指令时间。
