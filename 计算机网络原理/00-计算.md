



# 概述

电路交换

> 1. 有连接的
> 2. 要先建立电路连接
> 3. 通信过程独占一个信道
> 4. 通信结束需要拆除电路连接
> 5. 优点：实时性高，时延和时延抖动都较小
> 6. 缺点：对于突发性数据传输，信道利用率低，传输速率单一
> 7. 适用于语音，视频等实时性强的业务

报文交换，也称消息交换

> 1. 不需要建立连接
> 2. 只有当报文被转发时才占用相应信道
> 3. 交换结点需要缓冲存储，报文需要排队，增加了时延
> 4. 存储空间不足或输出链路被占用不能及时转发时会丢弃报文（可能丢弃报文）
>
> 工作工程
>
> 发送方把要发送的数据附加上发送、接收主机的地址和其他控制信息构成一个完整的报文，然后以报文为单位在交换网络的各个结点之间以存储-转发的方式传送直到送到目的主机
>
> 缺点：延迟时间增加且不固定，报文可能被丢弃



分组交换网络

> 将要传输的数据拆分为较小的数据块，为每个数据块附加上地址，序号等控制信息构成数据分组；每个分组独立传输到目的地，目的地将接收到的分组重新组装还原为报文；

分组交换的优点

> - 交换设备存储容量要求低
>
> - 交换速度快
>
>   - 分组更小，可以利用`主存储器`，不用访问较慢的外存
>   - 多个分组可以在网络中的不同链路进行`并发处理`，提高传输效率和线路利用率
>
> - 可靠传输效率高
>
>   - 分组交换在出现差错时可以只`重传错误`的分组
>
> - 更加公平
>
>   - 分组后，所有报文都可以在不同的交换结点`交替排队`，每个分组通过网络的时间相当



## 分组长度与误码率

**分组长度与延迟时间**

- 基于**排队论**，相同长度的分组在交换过程中延迟时间较小
- 其他条件相同，分组**长度**越长延迟**时间**越长。实时交互式通信适合分组长度小，文件传输等非实时通信，长度可以适当增加。
- 分组太小，有效数据传输效率会降低， 需要在**延迟时间**与**开销**之间进行平衡

**分组长度与误码率**

- 分组长度 $L=x+h$,  x：数据长度， h：分组头长度
- $P_e$为信道误码率， 分组传输正确概率为：$P_s=（1-P_e）^{x+h}$     $P_s=（1-P_e）^L$
- 重发概率为 $1-P_s$
- 最佳分组长度为 $L_{opt}=\sqrt{\frac{h}{P_e}}$
- 最高信道利用率为 $\eta_{max}=(1-\sqrt{hP_e})^2$
- 分组长度建议在16B到4096B之间的$2^n$B为标准分组长度



时延

> 传输时延：数据长度/速率 L/R
>
> 传播时延：链路长度/信号速度 D/V
>
> 时延带宽积：G=传播时延*速率  $d_p\times R$ 



## 网络应用

http报文由起始行，首部行，空白行，实体主体 组成



Cookie 技术主要包含4个部分

>1. HTTP 响应报文中的Cookie首部： `Set-Cookie.` 发送大小一般不超过4K
>
>2. 用户浏览器在本地存储、维护和管理的Cookie文件. 
>
>  每当获得新的Cookie信息，便会在Cookie文件中追加一行Cookie信息，包括网站的`域、路径、内容、有效期、安全`5个字段
>
>3. HTTP请求报文中的 Cookie 首部：`Cookie`
>
>4. 网站在后台数据库中存储、维护Cookie信息

Cookie 使用场景

> 1. 利用Cookie的ID统计网站的使用情况， 例如：实际访问人数，新用户比例， 访问频率等
> 2. 利用Cookie限制特定用户的访问
> 3. 利用Cookie存储用户访问过程中的操作习惯和偏好，对不同用户提供不同的界面等
> 4. 记录用户登录网站使用的用户名密码等信息，不用重复输入
> 5. 电子商务网站通过Cookie实现购物车功能

SMTP

> 当TCP连接建立成功后，SMTP通过三个阶段的<u>应用层交换</u>完成邮件的传输：**握手阶段**、**邮件传输阶段**、**关闭阶段**
>
> `握手阶段`：客户端，服务端各自声明自己的身份
>
> `邮件传输阶段`：开始传输邮件数据
>
> `关闭阶段`：声明邮件传输结束，并关闭TCP连接

POP3

> POP3协议交互过程分为三个阶段：
>
> 1. 授权：用户代理向服务器发送用户名和口令（明文），安全性差; 两个主要命令：`user<username> 和 pass<password>`
> 2. 事务处理：用户代理向服务器发送POP3命令，实现邮件读取、为邮件做删除标记，获取邮件的统计信息等操作;
> 3. 更新：客户发出quit命令， 结束POP3会话，服务器删除被标记为删除的邮件
>
> POP3的消息应答主要有两种：
>
> 1. +OK 表示前面的命令是正常的
> 2. -ERR 表示前面的命令出现了差错





## HTTP

1. 请求一个资源需要2RTT时间（TCP连接+传输报文）

> 设某网页的URL为“http://www.abe.com/index.html”，且该URL对应的IP地址在你的计算机上没有缓存；文件index.html引用了8个小图像。
> 在域名解析的过程中，无等待的一次DNS解析请求与响应时间记为RTTd，
> HTTP请求传输Web对象过程的一次往返时间记为RTTh。试给出：
> （1）该URL中的域名； www.abe.com
> （2)浏览器解析到该URL对应的IP地址的最短时间和最长时间； 
> 	查询本地DNS最短， RTTd
> 	主机->LocalDNS->RootDns->顶级DSN：com->权威DNS abe.com 4RTTd
> （3)若浏览器没有配置并行TCP连接，则基于HTTP1.0获取该Web页的完整内容（包括引用的图像)所需要的时间（不包括域名解析时间)；
> 	请求一个资源需要2RTTh, 共9个资源; 需要18RTTh
> （4)若浏览器配置5个并行TCP连接，则基于HTTP1.0获取该Web页的完整内容（包括引用的图像）需要的时间（不包括域名解析时间)；
> 	每次5个并行TCP连接，一共有8个小图像，第一次传输5个，第二次传输剩余的3个，所以为2轮。
> 	每轮都要打开一次TCP连接用了1个RTTh，又同时传输图像用了一个RTTh，所以为2轮*2个RTTh=4RTTh，
> 	加上最初的2个用于开TCP连接和获取Html文件的RTTh，共计2+4=6RTTh
> （5）若浏览器没有配置并行TCP连接，则基于非流水方式的HTTP1.1获取该Web页完整内容需要的时间
> 	1RTTh（TCP持久连接）+ 1RTTh（1次html内容获取）+  8RTTh（8个图像传输时间） = 10RTTh。
>
> （6）基于流水方式的HTTP1.1获取该Web页的完整内容（包括引用的图像)需要的时间（不包括域名解析时间)。
> 	1RTTh（TCP持久连接）+ 1RTTh （1次html内容获取）+ 1RTTh（8个图像传输时间）= 3RTTh。



## 传输层

> 传输层主要实现功能
>
> 1. 传输层寻址
> 2. 对应用层报文进行分段和重组
> 3. 对报文进行差错检测
> 4. 实现进程间的端到端可靠数据传输控制
> 5. 面向应用层实现复用与分解
> 6. 实现端到端的流量控制
> 7. 拥塞控制等



不可靠信道的表现

> 1. 传输过程中可能发生`比特差错`，即比特跳变， 1变为0， 0变为1的现象
> 2. 传输过程中可能出现`乱序`， 即先发的数据包到
> 3. 传输过程中可能出现`数据丢失`



### 实现可靠数据传输的主要措施

> 1. 差错检测
>    1. 利用**差错编码**（`校验和`）实现数据包传输过程中的比特差错检测。
>    2. 差错编码是在数据上附件冗余信息，建立数据（位）之间的逻辑关系
>    3. 数据发送方对需要差错检测的数据进行差错编码;数据接收方依据相同的差错编码规则或算法，检验是否发生比特差错
> 2. 确认
>    1. 接收方向发送方反馈接收状态。ACK肯定确认， NAK否定确认
> 3. 重传
>    1. 发送方重新发送接收方没有正确接收的数据。 NAK时重传
> 4. 序号
>    1. 为数据包编号，确保数据按序提交。即使接收方没有按序接收，也可以根据数据包编号纠正顺序。
>    2. 同时编号可以避免同一数据包重复提交问题
> 5. 计时器
>    1. 解决数据丢失问题,在超时后没有收到接收方的确认，就主动重发



## 停等协议的性能

停等协议的**信道利用率**为：发送数据的时间/(往返时间+发送数据的时间)
$$
\begin{align}
U_{sneder}  & = \frac{传输时延}{往返时间+发送数据的时间} \\
& = \frac{t_{Seg}}{t_{Seg}+RTT}  \\
& = \frac{L/R}{RTT+L/R}
\end{align}
$$

---





**示例**：1Gbps 的网络， 15ms端到端传播延迟(RTT=15*2=30ms)， 1kb分组

L=1KB = 1024*8bit=8kbit

R=1Gbps = $10^9$b/s



传输时延：
$$
\begin{align*}
T_{transmit} & =\frac{L \text{(Packet length in bits)}}{R\text{ (transmission rate, bps)}} \\
& =\frac{8kb/pkt}{10^9/sec}\\
& =0.000008192s\\
& =8 微秒 \\

U_{sender} &= \frac{L/R}{RTT+L/R} \\
&=\frac{0.008}{3\add+0.008} \\
&=0.00027

\end{align*}
$$
![image-20220629205001687](../imgs/image-20220629205001687.png)



在1Gbps链路上每30毫秒才发送一个分组（1KB），1秒才发送33KB数据





## 滑动窗口协议信道利用率

假设报文段的序号采用k位二进制串进行编号，则其编号空间为：$0 \backsim 2^k-1$ 共$2^k$个编号。

滑动窗口协议的窗口大小与序列号空间需要满足以下约束：

1. $W_s + W_r \leq 2^k$

2. 特殊情况下， 对于GBN协议 $W_r=1$, 则 $W_s\leq2^k-1$

3. 对于典型的$W_s=W_r=W$的SR协议，有：$W_s \leq 2^{k-1}$, 发送方与接收方窗口的大小一致，各占一半

4. 停等协议，GBN，SR协议信道利用率可以统一表示为 $t_{seg} = L/R$
   $$
   U_{sender}=\frac{W_s\times{t_{Seg}}}{t_{Seg}+RTT+t_{ACK}}
   $$
   $W_s=1$ 就是停等协议

   对于滑动窗口协议，信道利用率与发送窗口的大小有关，$W_s$足够大时，可以使$W_s\times{t_{Seg}}$大于$t_{Seg}+RTT+t_{ACK}$成立， 此时利用率为100%



## IP数据报分片

> 假设IP数据报总长度为$L$字节， MTU为$M$字节， 且 $L>M \;\&\; DF=0$ 是路由器可以进行分片
>
> 每分片最大可封装的数据长度(字节) 
> $$
> d = \lfloor{\frac{M-20}{8}}\rfloor\times{8}
> $$
> 分片总数
> $$
> n=\lceil\frac{L-20}{d}\rceil
> $$
> 每分片片偏移量字段值
> $$
> F_i=\frac{d}{8}(i-1)\;,\; 1\leq{i}\leq{n}
> $$
> 每个分片的总长度字段值
> $$
> L_i=\begin{cases}  d+20\;,\; 1\leq{i}<n \\
> L-d\times{(i-1)}\;,\; i=n
> \end{cases}
> $$
> 每个分片MF值
> $$
> MF_i=\begin{cases} 1 \;,\; 1\leq{i}<n\\
> 0\;,\; i=n
> \end{cases}
> $$



## 连续信道容量

> 根据奈奎斯特第一准则，对于理想无噪声的基带传输系统，最大频带利用率为 2Baud/Hz;
>
> 如果传输M进制基带信号，则理想`无噪声`信道的信道容量为：
> $$
> C=2B\log_{2}M
> $$
>
> 香浓公式给出了`有噪声`连续信道的信道容量公式:
> $$
> C=B\log_2(1+\frac{S}{N})
> $$
> B: 信道的带宽、S: 输入信号的功率、N: 信道加性高斯白噪声
>
> S/N: 信噪比
>
> 信噪比转换关系：
> $$
> (\frac{S}{N})_{dB}=10\log_{10}(\frac{S}{N})_{功率}
> $$



示例

已知某信道容量为8kHz; 信噪比为30dB； 求该信道的信道容量C

1. 先转换信噪比
2. 在利用公式计算容量

> 信噪比$\frac{S}{N}_{功率}=10\log_{10}(\frac{S}{N})=10^{\frac{\frac{S}{N}}{10}}=10^{30/10}=1000$
>
> $C=B\log_2(1+\frac{S}{N})=8*10^3\log_2(1+1000)\approx 80kbit/s$















时延带宽积

> 设信号传播速度为250000km/s; 分组长度L=512bit; 链路带宽R=100Mbit/s, 则使时延带宽积刚好为一个分组长度的链路长度D多少？
>
> 时延带宽积=传播时延*带宽；即 $G=\frac{D}{V}\times R$
>
> $512=\frac{D}{250000} \times 100000$
>
> $D=512V/100000$
>
> D=1280m

对于10Mbps的基带CSMA/CD网，MAC帧的最短帧长为64字节



> 设A、B两站之间相距2km，链路使用CSMA/CD协议进行通信。信号在网络上的传播速率为200000km/s，两站的发送速率为1Gbps，A首先发送数据，如果发生碰撞，试计算：
>
> (1)A站至多经过多长时间才能够检测到发生了碰撞?
>
> 最先发送数据的A站最晚经过2个传播时延才能检测到发生碰撞， 即 2*（2Km/200000Km/s）=20us
>
> (2)假设A要发送的帧足够长，检测到碰撞后，A已经发送了多少位数据?(要求写出计算过程）
>
> 20us可以发送数据 1Gbps*20us=20000bit

